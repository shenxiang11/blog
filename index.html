<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>前端芯事</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="前端芯事">
<meta property="og:url" content="https://shenxiang11.github.io/blog/index.html">
<meta property="og:site_name" content="前端芯事">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="芯芯爸爸">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="前端芯事" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">前端芯事</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://shenxiang11.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-仿一个-AppStore-效果" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/05/04/%E4%BB%BF%E4%B8%80%E4%B8%AA-AppStore-%E6%95%88%E6%9E%9C/" class="article-date">
  <time class="dt-published" datetime="2023-05-04T11:44:18.000Z" itemprop="datePublished">2023-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/05/04/%E4%BB%BF%E4%B8%80%E4%B8%AA-AppStore-%E6%95%88%E6%9E%9C/">仿一个 AppStore 效果</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>五一在家，看了之前 Anthony Fu 的直播录播，内容是制作一个跨路由的共享元素的动画的组件库，大致听了一下思路，了解了其原理，自己便尝试利用他后来发布的这个组件库做了一个动画效果。</p>
<p><img src="/blog/resources/2023-05/02.gif"></p>
<h2 id="现聊聊这个组件库的思路"><a href="#现聊聊这个组件库的思路" class="headerlink" title="现聊聊这个组件库的思路"></a>现聊聊这个组件库的思路</h2><p>最早，Fu 分享的是 FLIP 的思路可以做。FLIP 大致是把元送从最终位置移动到初始位置，由于还没有发生渲染，用户是不知道元素已经到达最终位置了，然后再利用动画将元素播放到最终位置。</p>
<p>这就是 FLIP 的大致原理，具体的可以留到下次手撸一个 FLIP 动画效果后再分享。</p>
<p>这中对于简单元素的效果，还是能够接受的，但是对于整个组件做这种 FLIP 动画，由于其实是两个组件，它们直接的状态是不能直接共享的，当然你可以使用状态管理解决，但是为了一个动画效果，这太“重”了。</p>
<p>Fu 的思路是将整个组件使用 Vue3 的 Teleport，把组件从组件树上挪动，像是星际争霸游戏里人族建筑可以从地上飞起现浮动在天上，再移动到目标位置下降的过程，非常形象生动。</p>
<p>虽然，这是一个 Vue 的库，应用到其他框架里，原理上也是没有问题的。</p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>我发现组件状态虽然能够共享了，但是你如果注意到我的截图后，你会发现组件的动画又重新开始播放了，这是由于我用的 CSS 做的动画，组件在 dom 中移动后导致动画重新开始。</p>
<p>这就意味着，我至少需要额外的工作去记录一下动画播放的位置，下次重新播放是需要从这个位置开始，同样也会新增一点复杂性。我这一次不打算优化了。</p>
<h2 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h2><p>可以说这个动画效果已经非常接近原生了，这种动画效果 Flutter 里和 Swift 里都有同一个称呼 Hero，Flutter 里是官方支持的原生组件，Swift 里则是第三方库。</p>
<p>在之前做原生开发时，就觉得效果非常的神奇，但是原理基本不知道。没想动 Web 里，同样能够实现这种效果，相信 Web 开发会越来越好。</p>
<h2 id="额外收获总结"><a href="#额外收获总结" class="headerlink" title="额外收获总结"></a>额外收获总结</h2><ul>
<li>Vue 框架，可以在 Style 里使用 <code>v-bind(x)</code> 绑定变量，之前知道这个功能没有试过，这次应用这个来控制动画需要移动的位置。</li>
<li>不是第一次使用 tailwindcss 了，发现用来写点小项目，还是非常方便的，但是好多样式对应的缩写不是很能够对应的上。</li>
<li>看见 Fu 使用 degit 创建项目，下次可以自己做一个项目模版，方便快速开发。</li>
<li>使用 scrollBehavior 控制 vue-router 的跳转后滚动条的位置。（太久不用这块了，忘记了）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/05/04/%E4%BB%BF%E4%B8%80%E4%B8%AA-AppStore-%E6%95%88%E6%9E%9C/" data-id="clh8m1lnn000jbxq9fqa8esp2" data-title="仿一个 AppStore 效果" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue-js/" rel="tag">Vue.js</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React-Strict-Mode-的作用：为什么要-Render-两次" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/05/03/React-Strict-Mode-%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-Render-%E4%B8%A4%E6%AC%A1/" class="article-date">
  <time class="dt-published" datetime="2023-05-03T08:55:19.000Z" itemprop="datePublished">2023-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/05/03/React-Strict-Mode-%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-Render-%E4%B8%A4%E6%AC%A1/">React Strict Mode 的作用：为什么我的 `useEffect` 执行了两次</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前，React 的脚手架创建出来的项目的根组件会被 StrictMode 包裹，官方的说法是它可以让我们在开发期间尽早地发现常见的 bug。</p>
<p>总体来说，它可以：</p>
<ul>
<li>在整个组件树中生效。</li>
<li>也可以让一部分组件树开启严格模式。</li>
<li>开发期间会有两次渲染，我们可以发现一些错误。</li>
<li>开发期间副作用会被重新执行，我们可以发现一些错误。</li>
<li>严格模式会对被弃用的 API 发出警告，我们可以做一些修改。</li>
</ul>
<h2 id="全局严格模式和局部严格模式"><a href="#全局严格模式和局部严格模式" class="headerlink" title="全局严格模式和局部严格模式"></a>全局严格模式和局部严格模式</h2><p>我们只需要在需要严格模式的地方，将组件用 <code>&lt;StrictMode&gt;</code> 包裹即可，其实如果我们的项目没有什么历史报复的话，我们使用全局模式即可。</p>
<p>是否要开启全局模式，取决与你或你的团队是否会犯一些低级错误，需不需要对即将弃用的 API 发出警告。</p>
<p>官方提到的注意事项是，如果一个 React App 由两个团队维护的话，需要达成共识，因为一旦启用严格模式，从启用严格模式的组件开始，其子组件是无法退出严格模式的。</p>
<h2 id="开发时，两次渲染"><a href="#开发时，两次渲染" class="headerlink" title="开发时，两次渲染"></a>开发时，两次渲染</h2><p>官方有一个犯错误的示例代码，它对 <code>props</code> 上传入的一个 <code>Array</code> 类型的数据做了 <code>push</code> 操作，严格模式的两次渲染就会 <code>push</code> 两次，我们就可以及时从界面上发现我们的错误。</p>
<p>这里吐槽一下，自己和身边同事还没有发现会这样写 react 代码的，但是这个作用聊胜于无吧。</p>
<h2 id="开发时，重新执行副作用"><a href="#开发时，重新执行副作用" class="headerlink" title="开发时，重新执行副作用"></a>开发时，重新执行副作用</h2><p>这就是本文标题里提到的问题。</p>
<p>官方的错误代码是一个连接聊天室的应用的例子，它犯的错误是没有在适合的时候断开连接。</p>
<p>两次执行副作用，如果我们没有在 <code>useEffect</code> 的 <code>return</code> 函数里断开连接，会导致有两次连接，真实场景下应该是会报错的，我们可以提前发现这种漏洞。</p>
<p>一般我们的应用会在 <code>useEffect</code> 里发送网络请求，这时候如果不知道严格模式的小伙伴可能就会慌了，以为是哪里写了 bug。</p>
<p>而我们如果知道了严格模式的这一现象，而且 build 后并不会有这个问题，我们就不会慌了。</p>
<h2 id="对被弃用的-API-发出警告"><a href="#对被弃用的-API-发出警告" class="headerlink" title="对被弃用的 API 发出警告"></a>对被弃用的 API 发出警告</h2><p>官方给了一些弃用的 API 作为例子，然而全都是 class 组件里的，真的已经很少用了。</p>
<p>我们简单了解一下严格模式的这个作用即可，如果碰到旧项目里出现问题，可以适当根据警告对代码做出修改。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/05/03/React-Strict-Mode-%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-Render-%E4%B8%A4%E6%AC%A1/" data-id="clh8m1lnh000abxq9g9d2d5rx" data-title="React Strict Mode 的作用：为什么我的 `useEffect` 执行了两次" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/React-js/" rel="tag">React.js</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-null-和-undefined-的区别：看看祖师爷是怎么说的" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/05/02/null-%E5%92%8C-undefined-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%E7%9C%8B%E7%9C%8B%E7%A5%96%E5%B8%88%E7%88%B7%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%B4%E7%9A%84/" class="article-date">
  <time class="dt-published" datetime="2023-05-02T11:06:05.000Z" itemprop="datePublished">2023-05-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/05/02/null-%E5%92%8C-undefined-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%E7%9C%8B%E7%9C%8B%E7%A5%96%E5%B8%88%E7%88%B7%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%B4%E7%9A%84/">null 和 undefined 的区别：看看祖师爷是怎么说的</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言：困惑的产生"><a href="#前言：困惑的产生" class="headerlink" title="前言：困惑的产生"></a>前言：困惑的产生</h2><p>平时，我们在使用 Javascript 时，<code>undefined</code> 和 <code>null</code> <strong>几乎</strong>没有区别。</p>
<p>而在使用 TS 时，我们又明确的可以知道，它们是完全两种不同的类型，不可以互相赋值，在使用时并不完全等价，这就对我们的使用造成了困惑：到底什么时候用哪个，到底有什么区别。</p>
<p>据我所知，目前 JS 是唯一一个拥有两个表示“空”的类型的语言。</p>
<h2 id="了解历史"><a href="#了解历史" class="headerlink" title="了解历史"></a>了解历史</h2><p>查阅了一些资料，了解到，最早的 js 的版本中，是只有 <code>null</code> 的，JS 的一些设计参照了其他语言，而 null 在类型转换时可以转换为 0。</p>
<p>在 C 语言中，函数执行成功或是失败是人为约定的，比如比较常见的约定是执行成功返回 0，失败则返回其他数字。</p>
<p>而如果我们的 JS 也是这样，null 在自动转换为 0 的时候，往往不容易发现错误。</p>
<p>不知道是不是这个原因，Brendan Eich 觉得 <code>null</code> 不够好， 又在后续的版本中又设计了一个 <code>undefined</code>，而且已经添加了并被广泛使用。</p>
<p><code>undefined</code> 在转换成数字类型时，返回 <code>NaN</code>，这是它们直接一个明显的区别。</p>
<h2 id="为什么大厂里不允许显示使用-undefined"><a href="#为什么大厂里不允许显示使用-undefined" class="headerlink" title="为什么大厂里不允许显示使用 undefined"></a>为什么大厂里不允许显示使用 <code>undefined</code></h2><p>看过一些分享，说大厂里不允许直接使用 <code>undefined</code>，而是使用 <code>void 0</code> 来代替，它的返回结果是 <code>undefined</code>。</p>
<p>因为，<code>undefined</code> 不是 JS 里的关键字，它是 <code>window.undefined</code>，即 window 上的一个变量，在现代的 JS 中，它被属性描述符号限制了不可修改了，避免我们犯低级错误。</p>
<p>而在非全局作用域下，我们依然可以 <code>let undefined = xxx</code> 这还是需要小心的，我们不妨学习大厂的做法，在 code review 时，避免团队里出现显示使用 <code>undefined</code> 的代码。</p>
<p><code>undefined</code> 是一个变量，<code>null</code> 是一个关键字，这是它们的第二个区别。</p>
<h2 id="看看祖师爷怎么说"><a href="#看看祖师爷怎么说" class="headerlink" title="看看祖师爷怎么说"></a>看看祖师爷怎么说</h2><p>截图是 2015 年的一则推文，地址是：<a target="_blank" rel="noopener" href="https://twitter.com/BrendanEich/status/617450289889607681">https://twitter.com/BrendanEich/status/617450289889607681</a></p>
<p><img src="/blog/resources/2023-05/01.png"></p>
<p>大致意思是一个开发者问为什么 <code>typeof null</code> 的结果是 <code>object</code>，祖师爷首先回复了，<code>null</code> 表示 <code>no object</code>, <code>undefined</code> 表示 <code>no value</code>。</p>
<p>随后回答了这个问题，表示 <code>typeof null</code> 的结果是 <code>object</code> 是一个漏洞。</p>
<p>所以第三个区别是 <code>typeof null</code> 的结果是 <code>object</code>，而 <code>typeof undefined</code> 是 <code>undefined</code>。</p>
<h2 id="总结：目前前端环境里的表现"><a href="#总结：目前前端环境里的表现" class="headerlink" title="总结：目前前端环境里的表现"></a>总结：目前前端环境里的表现</h2><p>我们知道：</p>
<ul>
<li>转换成 bool 时，它们都是 false。</li>
<li>如果我们仅声明一个变量，未赋值，它的值是 <code>undefined</code>，对象的没有赋值的属性也是一样。</li>
<li>JS 函数默认的返回值是 <code>undefined</code>。</li>
<li>原型链的终点是 <code>null</code>。</li>
<li>调用函数时，没有传入的参数会是 <code>undefined</code>。</li>
<li>在前端环境里的现成的实现里，如 <code>document.getElementById(&#39;&#39;)</code> 如果没有选择器匹配返回的是 null。这种实现和祖师爷说的是保持一致的，</li>
</ul>
<p>甚至我们如果把 <code>null</code> 的 <code>typeof</code> 的设计缺陷，理解为 <code>null</code> 是特别的一种对象，表示这个对象不存在，是“空对象”，也是没有问题的。</p>
<p>再总结一下，前文提到的具体几处区别：</p>
<ul>
<li><code>undefined</code> 在转换成数字类型时，回返回 <code>NaN</code>；<code>null</code> 则是 0。</li>
<li><code>undefined</code> 是一个变量，<code>null</code> 是一个关键字</li>
<li><code>typeof null</code> 的结果是 <code>object</code>，而 <code>typeof undefined</code> 是 <code>undefined</code>。</li>
</ul>
<p>在 JS 里我们混着用并没有什么区别，但是现在我们知道了一点它们的区别，祖师爷也给出了使用的建议，我们基本上按照他的建议来使用即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/05/02/null-%E5%92%8C-undefined-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%E7%9C%8B%E7%9C%8B%E7%A5%96%E5%B8%88%E7%88%B7%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%B4%E7%9A%84/" data-id="clh8m1lnm000hbxq9ckzl8nqs" data-title="null 和 undefined 的区别：看看祖师爷是怎么说的" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-在-gin-项目中使用-swagger" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/25/%E5%9C%A8-gin-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-swagger/" class="article-date">
  <time class="dt-published" datetime="2023-04-25T09:57:23.000Z" itemprop="datePublished">2023-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/25/%E5%9C%A8-gin-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-swagger/">在 gin 项目中使用 swagger</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>准备开发一个低代码的问卷项目，类似于问卷星，后端采用 gin，前后端沟通的最重要部分是文档，但是我不想手动维护文档，所以采用 swagger 来生成。</p>
<h2 id="main-代码"><a href="#main-代码" class="headerlink" title="main 代码"></a>main 代码</h2><p><code>main</code> 函数上的注释，后续会成为文档的一部分，同样会成为文档一部分的是，下一部分 controller 上的注释。</p>
<p>除了导入 swagger 相关的包，我们还需要导入项目的一个目录，它是由 <code>swag init</code> 命令自动生成的，如果不导入会遇到，swagger 网站打开后加载 json 失败的问题。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	swaggerFiles <span class="string">&quot;github.com/swaggo/files&quot;</span></span><br><span class="line">	ginSwagger <span class="string">&quot;github.com/swaggo/gin-swagger&quot;</span></span><br><span class="line">	_ <span class="string">&quot;survey-api/docs&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// @title 问卷项目</span></span><br><span class="line"><span class="comment">// @description 项目练习</span></span><br><span class="line"><span class="comment">// @version 1.0</span></span><br><span class="line"><span class="comment">// @contact.name golang</span></span><br><span class="line"><span class="comment">// @contact.url https://www.baidu.com</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	api.RegisterHandlers(r)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/swagger/*any&quot;</span>, ginSwagger.WrapHandler(swaggerFiles.Handler, ginSwagger.PersistAuthorization(<span class="literal">true</span>)))</span><br><span class="line"></span><br><span class="line">	srv := &amp;http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">&quot;:8000&quot;</span>,</span><br><span class="line">		Handler: r,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err := srv.ListenAndServe()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="controller-代码"><a href="#controller-代码" class="headerlink" title="controller 代码"></a>controller 代码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> inquirer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;survey-api/domain/inquirer&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</span><br><span class="line">	inquirerService *inquirer.Service</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInquirerController</span><span class="params">(service *inquirer.Service)</span></span> *Controller &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Controller&#123;inquirerService: service&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateInquirer godoc</span></span><br><span class="line"><span class="comment">// @Summary 创建问卷平台的用户</span></span><br><span class="line"><span class="comment">// @Tags Auth</span></span><br><span class="line"><span class="comment">// @Accept json</span></span><br><span class="line"><span class="comment">// @Product json</span></span><br><span class="line"><span class="comment">// @Param CreateUerRequest body CreateInquirerRequest true &quot;表单&quot;</span></span><br><span class="line"><span class="comment">// @Success 201 &#123;object&#125; CreateInquirerResponse</span></span><br><span class="line"><span class="comment">// @Failure 400 &#123;object&#125; api_helper.ErrorResponse</span></span><br><span class="line"><span class="comment">// @Router /inquirer [post]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> CreateInquirer(g *gin.Context) &#123;</span><br><span class="line">	<span class="keyword">var</span> req CreateInquirerRequest</span><br><span class="line">	<span class="keyword">if</span> err := g.ShouldBind(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handleError</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	i := inquirer.NewInquirer(req.Email, req.Username, req.Password)</span><br><span class="line">	err := c.inquirerService.Create(i)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handleError</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.JSON(http.StatusCreated, CreateInquirerResponse&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们基本上，只需要按这个模版写上少量注释，就能够生成文档。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>swagger 网站的默认风格调用 api 还是非常不方便的，我暂时没有发现更换现成主题的方式，但是它只是支持导入到 postman 的，我们可以在 postman 里进行接口的测试。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/25/%E5%9C%A8-gin-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-swagger/" data-id="clh8m1lnp000lbxq94ldt2jtb" data-title="在 gin 项目中使用 swagger" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/gin/" rel="tag">gin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/go/" rel="tag">go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/swagger/" rel="tag">swagger</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Node-js-打通微信小程序支付" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/23/Node-js-%E6%89%93%E9%80%9A%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98/" class="article-date">
  <time class="dt-published" datetime="2023-04-23T14:25:08.000Z" itemprop="datePublished">2023-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/23/Node-js-%E6%89%93%E9%80%9A%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98/">Node.js 打通微信小程序支付</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>支付是电商最重要的一个环节，在小程序中前端基本只需要调用 api 即可，一些重要逻辑是放在后端的，且不是每一个开发都会接触这一块内容。</p>
<p>这次借用到了企业支付的资质，就实践一下支付并记录此过程。</p>
<p>完成后，可以在小程序中成功唤起支付，并在以后应用到项目里。</p>
<p><img src="/blog/resources/2023-04/09.gif"></p>
<h2 id="准备小程序前端"><a href="#准备小程序前端" class="headerlink" title="准备小程序前端"></a>准备小程序前端</h2><p>我们只需要在官方示例项目里添加网络请求，然后把请求结果的必要参数传递给 <code>requestPayment</code> 即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// 获取应用实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">getApp</span>()</span><br><span class="line"></span><br><span class="line"><span class="title class_">Page</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">handlePay</span>(<span class="params"></span>) &#123;</span><br><span class="line">    wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;http://192.168.1.3:3000/pay&#x27;</span>,</span><br><span class="line">      <span class="title function_">success</span>(<span class="params">res</span>) &#123;</span><br><span class="line">        wx.<span class="title function_">requestPayment</span>(&#123;</span><br><span class="line">          <span class="attr">nonceStr</span>: res.<span class="property">data</span>.<span class="property">nonceStr</span>,</span><br><span class="line">          <span class="attr">package</span>: res.<span class="property">data</span>.<span class="property">package</span>,</span><br><span class="line">          <span class="attr">signType</span>: res.<span class="property">data</span>.<span class="property">signType</span>,</span><br><span class="line">          <span class="attr">paySign</span>: res.<span class="property">data</span>.<span class="property">paySign</span>,</span><br><span class="line">          <span class="attr">timeStamp</span>: res.<span class="property">data</span>.<span class="property">timeStamp</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="支付后端"><a href="#支付后端" class="headerlink" title="支付后端"></a>支付后端</h2><p>这里我就简单使用了 koa 作为支付后端，并且简单到不需要使用路由功能。</p>
<p>登录我也不打算作，我自己的 openid 在以前我测试这个小程序的时候获取过，我记录了下来直接使用，在下面代码里我隐去了。</p>
<p>同时我把一些敏感信息一并隐去了，如：商户 id，支付密钥等。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;js2xml, xml2js&#125; = <span class="built_in">require</span>(<span class="string">&#x27;xml-js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> dict = &#123;</span><br><span class="line">    <span class="attr">xml</span>: &#123;</span><br><span class="line">      <span class="attr">body</span>: <span class="string">&#x27;JSAPI支付测试&#x27;</span>,</span><br><span class="line">      <span class="attr">appid</span>: <span class="string">&#x27;你的小程序 id&#x27;</span>,</span><br><span class="line">      <span class="attr">mch_id</span>: <span class="string">&#x27;商户 id&#x27;</span>,</span><br><span class="line">      <span class="attr">nonce_str</span>: <span class="title function_">generateNonceStr</span>(), <span class="comment">// 随机字符串，长度要求在32位以内。调用随机数函数生成，将得到的值转换为字符串</span></span><br><span class="line">      <span class="attr">notify_url</span>: <span class="string">&#x27;http://127.0.0.1/notify&#x27;</span>,</span><br><span class="line">      <span class="attr">openid</span>: <span class="string">&#x27;支付用户的 openid&#x27;</span>, <span class="comment">// 懒得做登录系统了</span></span><br><span class="line">      <span class="attr">out_trade_no</span>: <span class="string">&#x27;3783-6c16-4fab-83ff-6f193d70111&#x27;</span>, <span class="comment">// 商户系统内部订单号，要求32个字符内，只能是数字、大小写字母_-|*且在同一个商户号下唯一</span></span><br><span class="line">      <span class="attr">spbill_create_ip</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">      <span class="attr">total_fee</span>: <span class="number">10</span>, <span class="comment">// 订单总金额，单位为分</span></span><br><span class="line">      <span class="attr">trade_type</span>: <span class="string">&#x27;JSAPI&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(dict.<span class="property">xml</span>).<span class="title function_">sort</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">      str += <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;dict.xml[key]&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      str += <span class="string">`&amp;<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;dict.xml[key]&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  str += <span class="string">&#x27;&amp;key=&#x27;</span> + <span class="string">&#x27;你的 key&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sign = <span class="title function_">md5</span>(str)</span><br><span class="line">  dict.<span class="property">xml</span>.<span class="property">sign</span> = sign.<span class="title function_">toUpperCase</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> d = <span class="title function_">js2xml</span>(dict, &#123;<span class="attr">compact</span>: <span class="literal">true</span>, <span class="attr">ignoreComment</span>: <span class="literal">true</span>, <span class="attr">spaces</span>: <span class="number">2</span>&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> axios.<span class="title function_">post</span>(<span class="string">&#x27;https://api.mch.weixin.qq.com/pay/unifiedorder&#x27;</span>, d, &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = <span class="title function_">xml2js</span>(res.<span class="property">data</span>, &#123;<span class="attr">compact</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> clientDict = &#123;</span><br><span class="line">    <span class="attr">appId</span>: <span class="string">&#x27;你的小程序 id&#x27;</span>,</span><br><span class="line">    <span class="attr">timeStamp</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>()/<span class="number">1000</span>).<span class="title function_">toString</span>(),</span><br><span class="line">    <span class="attr">nonceStr</span>: <span class="title function_">generateNonceStr</span>(),</span><br><span class="line">    <span class="attr">package</span>: <span class="string">&#x27;prepay_id=&#x27;</span> + data.<span class="property">xml</span>.<span class="property">prepay_id</span>.<span class="property">_cdata</span>,</span><br><span class="line">    <span class="attr">signType</span>: <span class="string">&#x27;MD5&#x27;</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(clientDict).<span class="title function_">sort</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">      str += <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;clientDict[key]&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      str += <span class="string">`&amp;<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;clientDict[key]&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  str += <span class="string">&#x27;&amp;key=&#x27;</span> + <span class="string">&#x27;你的 key&#x27;</span></span><br><span class="line">  clientDict.<span class="property">paySign</span> = <span class="title function_">md5</span>(str)</span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">body</span> = clientDict</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateNonceStr</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>().<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>代码的大体流程就是准备参数，这里我是将微信文档里标记的必要参数都写了上去了，这应该是最少的参数了。</p>
<p>后端需要把这些参数传递给后端，其中 <code>sign</code> 是把这些参数按照其 key 的 ASCII 码排序拼接后进行 md5 后得到，再和原本的字段一起传递给微信服务器。</p>
<p>这里微信的入参和出参都是 xml 格式，我们利用 npm 包来转换成更方便使用的 json。</p>
<p>我们再把微信给我们的结果，做一样的加密工作，然后把所需参数传递给前端，即 <code>requestPayment</code>。</p>
<p>到这里，一个极简的支付就完成了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>吐槽一下，不知道为什么，微信至今还是用 xml 作为数据交换，哪怕兼容地加一种 json 方式呢？</p>
<p>之前，我其实用 java 写过类似的支付，当时整个流程用的现成的 SDK 来做支付，只需要传递必要参数就行，其实这次做完，发现支付其实也只是一个简单请求而已，代码量并不多，盲目用一些包，万一里面有什么恶意的逻辑就不好了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/23/Node-js-%E6%89%93%E9%80%9A%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98/" data-id="clh8m1lng0009bxq97ssl7nb7" data-title="Node.js 打通微信小程序支付" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Node-js/" rel="tag">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">微信小程序</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Flutter-与-iOS-通信：MethodChannel" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/23/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1%EF%BC%9AMethodChannel/" class="article-date">
  <time class="dt-published" datetime="2023-04-23T10:38:44.000Z" itemprop="datePublished">2023-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/23/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1%EF%BC%9AMethodChannel/">Flutter 与 iOS 通信：MethodChannel</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前分享了 <code>BasicMessageChannel</code>，看了官网了解到，它其实是最基础的一种方式，支持自定义消息的编解码器进行基本的异步消息传输。</p>
<p>一般的，我们使用 <code>MethodChannel</code>，也能达到 Flutter 请求调用原生方法，原生返回调用结果给 Flutter 的目的。</p>
<p>不得不说，Flutter 官网文档的例子十分地清楚，我从网站上跟随它的获取电池电量的例子，一次就成功了，下面就贴出代码，简单了解一下它的使用方式。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>创建 channel 的方式几乎和之前没有任何区别。通过 <code>channel.invoke(xxx)</code> 即可调用原生方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:flutter/material.dart&#x27;;</span><br><span class="line">import &#x27;package:flutter/services.dart&#x27;;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(const MyApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyApp extends StatelessWidget &#123;</span><br><span class="line">  const MyApp(&#123;Key? key&#125;) : super(key: key);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return MaterialApp(</span><br><span class="line">      title: &#x27;Flutter Demo&#x27;,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: const MyHomePage(title: &#x27;Flutter Demo Home Page&#x27;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;Key? key, required this.title&#125;) : super(key: key);</span><br><span class="line"></span><br><span class="line">  final String title;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  String _batteryLevel = &#x27;Unkown battery level.&#x27;;</span><br><span class="line">  static const _channel = MethodChannel(&quot;dev.battery.MethodChannel&quot;);</span><br><span class="line"></span><br><span class="line">  Future&lt;void&gt; _getBatteryLevel() async &#123;</span><br><span class="line">    String batteryLevel;</span><br><span class="line">    try &#123;</span><br><span class="line">      final int result = await _channel.invokeMethod(&quot;getBatteryLevel&quot;);</span><br><span class="line">      batteryLevel = &quot;Battery level at $result %.&quot;;</span><br><span class="line">    &#125; on PlatformException catch (e) &#123;</span><br><span class="line">      batteryLevel = &quot;Failed to get battery level: $&#123;e.message&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _batteryLevel = batteryLevel;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            Text(_batteryLevel)</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _getBatteryLevel,</span><br><span class="line">        tooltip: &#x27;Increment&#x27;,</span><br><span class="line">        child: Text(&quot;电量&quot;),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相应地，原生端建立同名的 channel，通过 <code>setMethodCallHandler</code> 根据调用的方法名调用原生方法即可，通过 <code>result</code> 将调用结果返回。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Flutter</span><br><span class="line"></span><br><span class="line"><span class="keyword">@UIApplicationMain</span></span><br><span class="line"><span class="keyword">@objc</span> <span class="keyword">class</span> <span class="title class_">AppDelegate</span>: <span class="title class_">FlutterAppDelegate</span> &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">application</span>(</span><br><span class="line">    <span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>,</span><br><span class="line">    <span class="params">didFinishLaunchingWithOptions</span> <span class="params">launchOptions</span>: [<span class="type">UIApplication</span>.<span class="params">LaunchOptionsKey</span>: <span class="keyword">Any</span>]<span class="operator">?</span></span><br><span class="line">  ) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> controller: <span class="type">FlutterViewController</span> <span class="operator">=</span> window<span class="operator">?</span>.rootViewController <span class="keyword">as!</span> <span class="type">FlutterViewController</span></span><br><span class="line">      <span class="keyword">let</span> batteryChannel <span class="operator">=</span> <span class="type">FlutterMethodChannel</span>(name: <span class="string">&quot;dev.battery.MethodChannel&quot;</span>, binaryMessenger: controller.binaryMessenger)</span><br><span class="line"></span><br><span class="line">      batteryChannel.setMethodCallHandler &#123; call, result <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">guard</span> call.method <span class="operator">==</span> <span class="string">&quot;getBatteryLevel&quot;</span> <span class="keyword">else</span> &#123;</span><br><span class="line">              result(<span class="type">FlutterMethodNotImplemented</span>)</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">self</span>.receiveBatteryLevel(result: result)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">GeneratedPluginRegistrant</span>.register(with: <span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.application(application, didFinishLaunchingWithOptions: launchOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">receiveBatteryLevel</span>(<span class="params">result</span>: <span class="type">FlutterResult</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> device <span class="operator">=</span> <span class="type">UIDevice</span>.current</span><br><span class="line">        device.isBatteryMonitoringEnabled <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> device.batteryState <span class="operator">==</span> <span class="type">UIDevice</span>.<span class="type">BatteryState</span>.unknown &#123;</span><br><span class="line">            result(<span class="type">FlutterError</span>(code: <span class="string">&quot;UNAVALIABLE&quot;</span>, message: <span class="string">&quot;Battery level not available.&quot;</span>, details: <span class="literal">nil</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result(<span class="type">Int</span>(device.batteryLevel <span class="operator">*</span> <span class="number">100</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>由于获取电量需要真机运行，特意录了屏。</p>
<p><img src="/blog/resources/2023-04/08.gif"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Flutter 的项目，原生端可以创建 Swift 类型的项目，文档的代码也很详细，这太友好了。iOS 都主推 swift 和 swiftUI 了， RN 却依然只能创建 oc 项目。</p>
<p>掌握了 <code>MethodChannel</code> 的通信方式，就能满足日常的开发需求了。</p>
<p>觉得 Flutter 的通信 api 设计的很好，简单易学，之前我自己探索的原生与 webview 的通信还是比较复杂的，传递的信息感觉不是很方便，后续继续去探索学习看看是否有更好的方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/23/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1%EF%BC%9AMethodChannel/" data-id="clh8m1lne0005bxq9hjuodzou" data-title="Flutter 与 iOS 通信：MethodChannel" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Flutter/" rel="tag">Flutter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Swift/" rel="tag">Swift</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/iOS/" rel="tag">iOS</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Flutter-与-iOS-通信-BasicMessageChannel" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/22/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1-BasicMessageChannel/" class="article-date">
  <time class="dt-published" datetime="2023-04-22T12:05:00.000Z" itemprop="datePublished">2023-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/22/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1-BasicMessageChannel/">Flutter 与 iOS 通信: BasicMessageChannel</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>BasicMessageChannel</code> 是适合在 Flutter 和原生端，用于传递字符串和半结构化信息的通信方式。</p>
<h2 id="Flutter-代码"><a href="#Flutter-代码" class="headerlink" title="Flutter 代码"></a>Flutter 代码</h2><p>为了方便，我们直接使用 Android Studio 创建 Flutter 工程，Swift 部分也使用工程创建出来的 iOS 目录即可。</p>
<p>为了简单，我们的演示以传递字符串为例。</p>
<p>下面的代码是基于官方计数器 DEMO 修改而来，删除了注释内容，补充了 <code>BasicMessageChannel</code> 部分代码，主要关注 <code>_MyHomePageState</code> 的 <code>initState</code> 内部的 <code>setMessageHandler</code> 和后面的 <code>_sendMessage</code> 方法。</p>
<p>前者是处理原生端发送过来的消息，并且还可以回复一条消息给原生端。</p>
<p>后者是向原生端发送消息，并且可以接收到原生端对于这一条消息的回复。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:flutter/material.dart&#x27;;</span><br><span class="line">import &#x27;package:flutter/services.dart&#x27;;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(const MyApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyApp extends StatelessWidget &#123;</span><br><span class="line">  const MyApp(&#123;Key? key&#125;) : super(key: key);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return MaterialApp(</span><br><span class="line">      title: &#x27;Flutter Demo&#x27;,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: const MyHomePage(title: &#x27;Flutter Demo Home Page&#x27;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;Key? key, required this.title&#125;) : super(key: key);</span><br><span class="line">  </span><br><span class="line">  final String title;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  static const _channel = BasicMessageChannel(&quot;dev.basicMessageChannel&quot;, StringCodec());</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  void initState() &#123;</span><br><span class="line">    super.initState();</span><br><span class="line"></span><br><span class="line">    _channel.setMessageHandler((message) async &#123;</span><br><span class="line">      print(&quot;1. flutter receive: $message&quot;);</span><br><span class="line">      return &quot;2. flutter reply receive&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;void&gt; _sendMessage() async &#123;</span><br><span class="line">    var message = await _channel.send(&quot;3. flutter send&quot;);</span><br><span class="line">    print(&quot;4. flutter receive swift reply ：$message&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _sendMessage,</span><br><span class="line">        tooltip: &#x27;Increment&#x27;,</span><br><span class="line">        child: Text(&quot;Send&quot;),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Swift-代码"><a href="#Swift-代码" class="headerlink" title="Swift 代码"></a>Swift 代码</h2><p>这部分，<code>setMessageHandler</code> 同样是接收 flutter 发送过来的消息并回复。</p>
<p>项目启动 5s 后，主动向 flutter 发送一条消息，并且在回调中接收 flutter 对于这条消息的回复。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Flutter</span><br><span class="line"></span><br><span class="line"><span class="keyword">@UIApplicationMain</span></span><br><span class="line"><span class="keyword">@objc</span> <span class="keyword">class</span> <span class="title class_">AppDelegate</span>: <span class="title class_">FlutterAppDelegate</span> &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">application</span>(</span><br><span class="line">    <span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>,</span><br><span class="line">    <span class="params">didFinishLaunchingWithOptions</span> <span class="params">launchOptions</span>: [<span class="type">UIApplication</span>.<span class="params">LaunchOptionsKey</span>: <span class="keyword">Any</span>]<span class="operator">?</span></span><br><span class="line">  ) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> controller: <span class="type">FlutterViewController</span> <span class="operator">=</span> window<span class="operator">?</span>.rootViewController <span class="keyword">as!</span> <span class="type">FlutterViewController</span></span><br><span class="line">      <span class="keyword">let</span> basicMessageChannel <span class="operator">=</span> <span class="type">FlutterBasicMessageChannel</span>(name: <span class="string">&quot;dev.basicMessageChannel&quot;</span>, binaryMessenger: controller.binaryMessenger, codec: <span class="type">FlutterStringCodec</span>.sharedInstance())</span><br><span class="line"></span><br><span class="line">      basicMessageChannel.setMessageHandler &#123; message, reply <span class="keyword">in</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;5. swift receive：<span class="subst">\(message)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">          reply(<span class="string">&quot;6. swift reply: <span class="subst">\(message)</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="operator">+</span> <span class="number">5.0</span>) &#123;</span><br><span class="line">          basicMessageChannel.sendMessage(<span class="string">&quot;7. swift send&quot;</span>) &#123; message <span class="keyword">in</span></span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&quot;8. swift receive flutter reply: <span class="subst">\(message)</span>&quot;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">GeneratedPluginRegistrant</span>.register(with: <span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.application(application, didFinishLaunchingWithOptions: launchOptions)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="运行起来"><a href="#运行起来" class="headerlink" title="运行起来"></a>运行起来</h2><p>由于修改了原生代码，我们需要执行 <code>flutter clean</code>，先用 flutter 把它运行起来，但是这样看不到原生端的日志。</p>
<p>又一个小技巧是我们后续从 xcode 启动项目，这样两端的日志我们都能看到。</p>
<p>下面我直接贴出我们项目的日志，前 5s 我们先不要点击按钮，先查看 swift 向 flutter 发送消息的情况，然后我们再点击一次按钮。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flutter: 1. flutter receive: 7. swift send</span><br><span class="line">8. swift receive flutter reply: Optional(2. flutter reply receive)</span><br><span class="line"></span><br><span class="line">5. swift receive：Optional(3. flutter send)</span><br><span class="line">4. flutter receive swift reply ：6. swift reply: Optional(3. flutter send)</span><br></pre></td></tr></table></figure>

<p>前 5s 原生发送了一条消息，所以第一条日志是 flutter 接收到了 swift 发送的消息。</p>
<p>随后 flutter 对消息做了回复，第二条日志表示 swift 接收到了 flutter 的回复消息。</p>
<p>点击按钮后，flutter 发送了一个消息，swift 接收到了。</p>
<p>最后，flutter 接收到了 swift 的回复消息。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>BasicMessageChannel</code> 是 Flutter 与原生最简单的通信方式，但它只能用于传递字符串和半结构化的信息，后面我们继续探索其他通信方式。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/22/Flutter-%E4%B8%8E-iOS-%E9%80%9A%E4%BF%A1-BasicMessageChannel/" data-id="clh8m1lnc0004bxq9gsc0ag6i" data-title="Flutter 与 iOS 通信: BasicMessageChannel" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Flutter/" rel="tag">Flutter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Swift/" rel="tag">Swift</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/iOS/" rel="tag">iOS</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-手写-min-vue-router" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/21/%E6%89%8B%E5%86%99-min-vue-router/" class="article-date">
  <time class="dt-published" datetime="2023-04-21T10:49:23.000Z" itemprop="datePublished">2023-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/21/%E6%89%8B%E5%86%99-min-vue-router/">手写 min-vue-router</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Vue-router 是 Vue 的官方路由，是金典的路由插件，本次挑战的是就是将官方路由模板改成使用自己编写一个简易的路由功能。</p>
<h2 id="通过-create-vue-创建项目"><a href="#通过-create-vue-创建项目" class="headerlink" title="通过 create-vue 创建项目"></a>通过 create-vue 创建项目</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create vue@3</span><br></pre></td></tr></table></figure>

<p>这是一个在命令行中交互的方式创建 vue 项目的方式，我们只需要选择 vue-router 即可，其他 typescript、pinia 之类的我们都不需要，项目跑起来以后，我们都会把 vue-router 替换掉。</p>
<p><img src="/blog/resources/2023-04/07.png"></p>
<p>初始项目，基本上就是左边两个链接，和右边显示路由相应的页面。</p>
<h2 id="将-vue-router-替换为-my-router"><a href="#将-vue-router-替换为-my-router" class="headerlink" title="将 vue-router 替换为 my-router"></a>将 vue-router 替换为 my-router</h2><p>下面是模版项目的代码，我只对 <code>import &#123; createRouter &#125; from &#39;vue-router&#39;</code> 改成了 <code>import &#123; createRouter &#125; from &#39;../my-router&#39;</code>，以及注释了 history 那一行。</p>
<p>在我的版本中，这次就只实现一下 history 模式的路由，所以不需要接收路由模式。</p>
<p>可以看到，现在和原本应用有关系的地方是 <code>createRouter</code> 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;../my-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">HomeView</span> <span class="keyword">from</span> <span class="string">&#x27;../views/HomeView.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// history: createWebHistory(import.meta.env.BASE_URL),</span></span><br><span class="line">  <span class="attr">routes</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">HomeView</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>,</span><br><span class="line">      <span class="comment">// route level code-splitting</span></span><br><span class="line">      <span class="comment">// this generates a separate chunk (About.[hash].js) for this route</span></span><br><span class="line">      <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;../views/AboutView.vue&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>而 <code>createRouter</code> 创建出来的实例又被 <code>app.use(router)</code> 的形式使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./assets/main.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="简单了解-app-use"><a href="#简单了解-app-use" class="headerlink" title="简单了解 app.use"></a>简单了解 app.use</h2><p>我说再多都不如官网的介绍: <a target="_blank" rel="noopener" href="https://cn.vuejs.org/guide/reusability/plugins.html#introduction">跳转官网</a>。</p>
<p>简单总结就是，我们的 <code>router</code> 对象上需要一个 <code>install</code> 方法，调用 <code>use</code> 的 <code>app</code> 会作为第一个参数传给我们。</p>
<p>用过 vue-router 都会比较清楚，它提供了两个内置组件，<code>RouterLink</code> 和 <code>RouterView</code>，我们就可以在这个时候去注册这两个组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">RouterLink</span> <span class="keyword">from</span> <span class="string">&quot;./RouterLink&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">RouterView</span> <span class="keyword">from</span> <span class="string">&#x27;./RouterView&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ref&#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRouter</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> router = &#123;</span><br><span class="line">        <span class="attr">routes</span>: options.<span class="property">routes</span>,</span><br><span class="line">        <span class="attr">current</span>: <span class="title function_">ref</span>(location.<span class="property">path</span> || <span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">        <span class="title function_">install</span>(<span class="params">app, a</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> router = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">            app</span><br><span class="line">                .<span class="title function_">component</span>(<span class="string">&#x27;RouterLink&#x27;</span>, <span class="title class_">RouterLink</span>)</span><br><span class="line">                .<span class="title function_">component</span>(<span class="string">&#x27;RouterView&#x27;</span>, <span class="title class_">RouterView</span>);</span><br><span class="line"></span><br><span class="line">            app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$router</span> = router;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;popstate&#x27;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">        router.<span class="property">current</span>.<span class="property">value</span> = event.<span class="property">state</span>.<span class="property">to</span>;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> router;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为前面说我们实现的是 history 的模式，所以这里额外有一个对 <code>popstate</code> 的监听，这是对浏览器后退的监听，我们将跳转的路径绑定到 <code>router</code> 的 <code>current</code> 属性上。</p>
<p>额外提一句，如果是实现 hash 模式，在这里监听 <code>hashChange</code> 就可以，不需要在 <code>RouterLink</code> 中监听点击，会更容易实现。</p>
<p>注意这里使用了 <code>ref</code>，我希望它是响应式的，这会在 <code>router-view</code> 中用到。</p>
<p>同时，我将业务注册的 <code>routes</code>，即 <code>Home</code> 和 <code>About</code>，直接放到了 <code>router</code> 上，后面也会在 <code>router-view</code> 中用到。</p>
<p>最后，router 自身也通过 <code>app.config.globalProperties.$router</code> 的形式放到了 app 上，我们使用 <code>current</code> 的时候需要从这里取出。</p>
<h2 id="编写-RouterLink-代码"><a href="#编写-RouterLink-代码" class="headerlink" title="编写 RouterLink 代码"></a>编写 RouterLink 代码</h2><p>一开始，我们只需要返回一个显示任意内容的组件即可，随后去页面上查看是否能够显示。</p>
<p>RouterLink 会有一个 <code>to</code> 参数，代表需要跳转的目标路径。还有一个 slot，一般是一段文字。</p>
<p>所以我们利用 <code>h</code> 函数来渲染这个组件，使用 <code>slots.default()</code> 来渲染插槽。具体代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineComponent, getCurrentInstance, h &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">        <span class="attr">to</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params">props, &#123; slots &#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> app = <span class="title function_">getCurrentInstance</span>()</span><br><span class="line">        <span class="keyword">const</span> &#123; to &#125; = props</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">h</span>(</span><br><span class="line">                <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">href</span>: to,</span><br><span class="line">                    <span class="title function_">onClick</span>(<span class="params">e</span>) &#123;</span><br><span class="line">                        e.<span class="title function_">preventDefault</span>()</span><br><span class="line">                        <span class="keyword">const</span> data = &#123; to &#125;</span><br><span class="line">                        history.<span class="title function_">pushState</span>(data, <span class="string">&#x27;&#x27;</span>, to)</span><br><span class="line">                        app.<span class="property">proxy</span>.<span class="property">$router</span>.<span class="property">current</span>.<span class="property">value</span> = to</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                slots.<span class="title function_">default</span>()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>跳转时，我们禁用默认行为，该用 <code>pushState</code> 跳转，<code>pushState</code> 的第一个参数，会在 <code>popState</code> 时获得，所以它也需要记录 <code>to</code> 这个参数。</p>
<p>上一节提到的 <code>current</code>，我们以 <code>app.proxy.$router.current</code> 这个形式获得，在 <code>setup</code> 里可以这么获取，但是翻了官网没有看到这部分内容，后续可以再跟进一下。</p>
<h2 id="编写-RouterView-代码"><a href="#编写-RouterView-代码" class="headerlink" title="编写 RouterView 代码"></a>编写 RouterView 代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;defineAsyncComponent, defineComponent, getCurrentInstance, h, unref&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> app = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line">            <span class="keyword">const</span> routes = app.<span class="property">proxy</span>.<span class="property">$router</span>.<span class="property">routes</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> component;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> r <span class="keyword">of</span> routes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.<span class="property">path</span> === <span class="title function_">unref</span>(app.<span class="property">proxy</span>.<span class="property">$router</span>.<span class="property">current</span>)) &#123;</span><br><span class="line">                    component = r.<span class="property">component</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (component) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> component === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> asyncComponent = <span class="title function_">defineAsyncComponent</span>(component);</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_">h</span>(asyncComponent, props);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_">h</span>(component, props);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;no match route&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>RouterView</code> 的功能就是选择匹配的组件进行展示，如果我们得到了组件，直接传递给 <code>h</code> 函数就能渲染。</p>
<p>特别地，<code>About</code> 在这里是一个异步组件，我们需要先调用 <code>defineAsyncComponent</code>。</p>
<p>匹配的逻辑，在这里就是一个依据 <code>current</code> 简单的在数组中的查找，没有支持嵌套的逻辑。</p>
<p>正应为 <code>current</code> 是响应式的，我们路由在切换时，我们也能够切换组件。</p>
<p>一个小技巧是使用 <code>unref</code>，如果我们不确定对象是否是一个 <code>ref</code>，或者是不想写 <code>.value</code> 时可以使用。</p>
<p>到这里，我们的这个应用又能够切换路由显示正确的组件了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过写一个简单的 vue-router，了解了其基本的原理，也学到了 vue 里不少基础的 api。</p>
<p>vue 和 vue-router 里依旧还有很多优秀代码值得探索，比如嵌套路由，路由钩子，动态参数等，后续可以继续学习。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/21/%E6%89%8B%E5%86%99-min-vue-router/" data-id="clh8m1lnt000tbxq97njd65y0" data-title="手写 min-vue-router" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue/" rel="tag">Vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue-router/" rel="tag">Vue-router</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-a-1-a-2-a-3-的几种下毒方法" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/20/a-1-a-2-a-3-%E7%9A%84%E5%87%A0%E7%A7%8D%E4%B8%8B%E6%AF%92%E6%96%B9%E6%B3%95/" class="article-date">
  <time class="dt-published" datetime="2023-04-20T17:52:26.000Z" itemprop="datePublished">2023-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/20/a-1-a-2-a-3-%E7%9A%84%E5%87%A0%E7%A7%8D%E4%B8%8B%E6%AF%92%E6%96%B9%E6%B3%95/">使 a === 1 &amp;&amp; a === 2 &amp;&amp; a === 3 为 true 的几种&#34;下毒&#34;方法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="/blog/resources/2023-04/06.jpeg"></p>
<p>这算得上是近些年的前端网红题了，曾经对这种网红题非常抵触，认为非常没有意义。</p>
<p>看到了不少人有做分享，有各种各样的方案，有涉及到 JS 非常基础的知识点，也不得不感叹解题者的脑洞之大。</p>
<p>但是，拿来做面试题为难没有看过的面试者，就非常非常不地道了。</p>
<h2 id="鹤顶红"><a href="#鹤顶红" class="headerlink" title="鹤顶红"></a>鹤顶红</h2><p>鹤顶红是武侠剧中出现最多的毒药，真的是江湖出行必备的毒药。</p>
<p>正常情况下，如果 <code>let a = 1;</code> 则，表达式的后半段必不成立。但是容易想到如果在每个阶段自增后，表达式是可能成立的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line">a++ === <span class="number">1</span> &amp;&amp; a++ === <span class="number">2</span> &amp;&amp; a++ === <span class="number">3</span>; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>可是这就属于把题改了，我们需要把自增的逻辑藏起来。由于 <code>a</code> 是基础类型，我们基本上不可能对其做什么改造了。</p>
<p>但是我们如果把 <code>a</code> 定义到 <code>window</code> 上，再加上诸如 <code>Object.defineProperty</code> 的 api，是能够做到的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tmp = <span class="number">1</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">window</span>, <span class="string">&#x27;a&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> tmp++;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">a === <span class="number">1</span> &amp;&amp; a === <span class="number">2</span> &amp;&amp; a === <span class="number">3</span>; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>由于 <code>defineProperty</code> 的限制，我们不能把 <code>1</code> 作为 <code>value</code>, 设置在属性描述符号内部，不得不外部定义一个变量。</p>
<p><code>defineProperty</code> 在诸如 Vue2 的框架中，用的非常多，几乎是面试高频会被问到的，所以这种“毒药”是你行走前端江湖必备的。</p>
<h2 id="曼陀罗"><a href="#曼陀罗" class="headerlink" title="曼陀罗"></a>曼陀罗</h2><p>曼陀罗这个名字颇具异域风情、《神雕侠侣》中杨过就是中了此毒。</p>
<p>说到这里我是要将此题改为另一道类似的题目：使 <code>a == 1 &amp;&amp; a == 2 &amp;&amp; a == 3</code> 返回 <code>true</code>。</p>
<p>将严格相等改为了普通的相等，因为通常代码规范中要求使用严格相等，导致 <code>==</code> 不常写，故将此命名为这个异域的名字。</p>
<p>正因为是不严格相等，我们可以利用 JS 中的类型转换机制来下毒。</p>
<p>这个机制是这样的：</p>
<ul>
<li>如果两个值类型相同，则之间进行比较，和全等是一样的。</li>
<li>如果一个是 null，另一个是 undefined，则相等。</li>
<li>如果一个是数值，另一个是字符串，把字符串转换为数值，再比较转换后的数值。</li>
<li>如果一个是 true，把它转成 1，再比较。</li>
<li>如果一个是 false，把它转成 0，再比较。</li>
<li>如果一个是对象，另一个是数值或字符串，会将对象转换为原始值，再比较。用到的是 valueOf() 和 toString() 方法。</li>
</ul>
<p>我们可以利用最后一点解这个题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">valueOf</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">value</span>++;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">a == <span class="number">1</span> &amp;&amp; a == <span class="number">2</span> &amp;&amp; a == <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>先前提到的那种解法必然也可以解这道题，但是这个写法不能用于上一道题，因为全等不会触发类型转换。</p>
<h2 id="十香软筋散"><a href="#十香软筋散" class="headerlink" title="十香软筋散"></a>十香软筋散</h2><p>此毒无色无香，药性一发作便全身筋骨酸软，数日后虽行动如常，内力半点发挥不出。毒药和解药表面无异，若中毒者再服毒药则气绝身亡。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a‌ = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> a‍ = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> a = <span class="number">3</span>;</span><br><span class="line">a‌ === <span class="number">1</span> &amp;&amp; a‍ === <span class="number">2</span> &amp;&amp; a === <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>你可能会说：“这段代码应该是会报错的！”。但是相信我，你复制到控制台执行一下试试。注意我这里有一个 <code>a</code> 是正常的 <code>a</code>，如果你有执行过上面别的方法，注意先刷新一下窗口。</p>
<p>是的 <code>const</code> 声明的是常量，理应抛出错误：<code>Identifier &#39;haha&#39; has already been declared</code>。</p>
<p>实际上，我这里定义的三个 <code>a</code> 是不同的变量，有一个是 <code>a</code>, 一个是 <code>ax</code>, 一个是 <code>ay</code>，其中 x, y 是被我替换为 unicode 里不可见的字符，所以在上面的代码里看到的都是 <code>a</code> 的形式。</p>
<p>我目前正在使用 webstorm 编辑这篇文章，我也发现了这些不可见字符会在编辑器里显示出来“怪怪的”，如果你也打开这篇 markdown，你会发现：</p>
<p><img src="/blog/resources/2023-04/05.png"></p>
<p>构造变量名称（唯一标识符）的通用规则是：</p>
<ul>
<li>名称可包含字母、数字、下划线和美元符号</li>
<li>名称必须以字母开头</li>
<li>名称也可以 $ 和 _ 开头</li>
<li>名称对大小写敏感（y 和 Y 是不同的变量）</li>
<li>保留字（比如 JavaScript 的关键词）无法用作变量名称</li>
</ul>
<p>实际上，使用中文，甚至是 emoji 表情作为变量名称都是合法的，所以这里可以使用不可见的 unicode 字符作为变量名。</p>
<p>当然，如果想要运行正确，我们得偷偷的把题改了，使用我们新声明的变量，虽然它们看起来一摸一样。</p>
<p>这种“下毒”，真是无色无味，正像软筋散一样。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这边汇总了二个针对原题的解法：通过使用 <code>Object.defineProperty</code> 和利用变量名称的规则的方法；</p>
<p>以及对它的变种题目：通过对象类型转化时默认调用 <code>valueOf</code> 函数的机制。</p>
<p>这道题至少也算给我们带来了三个 JS 基础知识点，好了，你（这道题）可以毒发身亡了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/20/a-1-a-2-a-3-%E7%9A%84%E5%87%A0%E7%A7%8D%E4%B8%8B%E6%AF%92%E6%96%B9%E6%B3%95/" data-id="clh8m1lnj000ebxq96b1w2o03" data-title="使 a === 1 &amp;&amp; a === 2 &amp;&amp; a === 3 为 true 的几种&#34;下毒&#34;方法" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="posts-Swift-原生应用与-WebView-互相通信" class="h-entry article article-type-posts" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/04/20/Swift-%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%B8%8E-WebView-%E4%BA%92%E7%9B%B8%E9%80%9A%E4%BF%A1/" class="article-date">
  <time class="dt-published" datetime="2023-04-20T11:10:33.000Z" itemprop="datePublished">2023-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/04/20/Swift-%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%B8%8E-WebView-%E4%BA%92%E7%9B%B8%E9%80%9A%E4%BF%A1/">Swift 原生应用与 WebView 互相通信</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="显示一个-Webview"><a href="#显示一个-Webview" class="headerlink" title="显示一个 Webview"></a>显示一个 Webview</h2><p>原本的 Web view 已经被标记为 deprecated 了，所以如果没有历史包袱，我们的项目应该使用 <code>WKWebView</code> 来显示我们的页面。</p>
<p>需要注意的是该控件并不在 <code>UIKit</code> 包里，我们需要导入 <code>Webkit</code>，具体的加载显示逻辑如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> WebKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_">UIViewController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> webview: <span class="type">WKWebView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        webview.load(<span class="type">URLRequest</span>(url: <span class="type">URL</span>(string: <span class="string">&quot;https://www.baidu.com&quot;</span>)<span class="operator">!</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在 iOS 中，显示我们的网页项目了。</p>
<p><img src="/blog/resources/2023-04/03.png" alt="03.png"></p>
<h2 id="Swift-调用-JS-代码"><a href="#Swift-调用-JS-代码" class="headerlink" title="Swift 调用 JS 代码"></a>Swift 调用 JS 代码</h2><p>我在原生端添加了一个按钮，点击后会调用 <code>callJS</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> WebKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_">UIViewController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> webview: <span class="type">WKWebView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        webview.load(<span class="type">URLRequest</span>(url: <span class="type">URL</span>(string: <span class="string">&quot;https://www.baidu.com&quot;</span>)<span class="operator">!</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">callJS</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="keyword">Any</span>) &#123;</span><br><span class="line">        webview.evaluateJavaScript(<span class="string">&quot;function test() &#123;return 1&#125;;test();&quot;</span>) &#123; result, err <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(of: result), result) <span class="comment">// Option(Any) Option(1)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(of: err), err) <span class="comment">// Option(Error) nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过 <code>evaluateJavaScript</code>，传入 JS 代码以执行，这样我们就可以方便地调用 JS 的全局方法了，我将执行结果写到了注释中。</p>
<p>调用的返回值或者调用过程中的错误，回通过 Swift 中的回调拿到。由于 JS 类型的灵活和两种语言的类型不是完全匹配的，result 的类型是 Option(Any)，err 的类型是 Optional<Error>。</p>
<h2 id="JS-端调用-Swift-方法"><a href="#JS-端调用-Swift-方法" class="headerlink" title="JS 端调用 Swift 方法"></a>JS 端调用 Swift 方法</h2><p>我的示例选择了一个 webview 调用 iOS 端的相册，然后 iOS 端将图片路径回调给 webview 的功能。</p>
<p><img src="/blog/resources/2023-04/04.gif" alt="04.gif"></p>
<p>由于两端交互使用了 file 协议，我后续也将网页改成了本地加载工程中的网页的形式，如果这一块不清楚，你可以跳到最后看最终代码。</p>
<p>可以通过 <code>webview.configuration.userContentController.add(self, name: &quot;showPhotoPicker&quot;)</code> 这个形式，往 webview 中注册原生方法。</p>
<p>我们在 webview 中，就可以通过 <code>webkit.messageHandlers.showPhotoPicker.postMessage(&quot;onGetPhoto&quot;);</code> 这个形式去调用原生方法。</p>
<p>这里的 postMessage 的参数，我设计为通知原生端选择图片后，应该调用的 JS 回调方法名称，这一步其实又是 Swift 调用 JS 了，我们可以通过 <code>WKScriptMessageHandler</code> 协议的 <code>message.body</code> 拿到它。</p>
<p>最后通过调用 JS，将图片的地址回传给 webview，以显示图片。</p>
<h2 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> WebKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">typealias</span> <span class="type">PhotoSelectedCallback</span> <span class="operator">=</span> (<span class="keyword">_</span> url: <span class="type">NSURL</span>) -&gt; <span class="type">Void</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_">UIViewController</span>, <span class="title class_">UINavigationControllerDelegate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> webview: <span class="type">WKWebView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> onPhotoSelected: <span class="type">PhotoSelectedCallback</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        webview.configuration.userContentController.add(<span class="keyword">self</span>, name: <span class="string">&quot;showPhotoPicker&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> htmlFile <span class="operator">=</span> <span class="type">Bundle</span>.main.path(forResource: <span class="string">&quot;index&quot;</span>, ofType: <span class="string">&quot;html&quot;</span>)<span class="operator">!</span></span><br><span class="line">        webview.loadFileURL(<span class="type">URL</span>(fileURLWithPath: htmlFile), allowingReadAccessTo: <span class="type">URL</span>(fileURLWithPath: htmlFile))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">callJS</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="keyword">Any</span>) &#123;</span><br><span class="line">        webview.evaluateJavaScript(<span class="string">&quot;function test() &#123;return1 1&#125;;test();&quot;</span>) &#123; result, err <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(of: result), result)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(of: err), err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// webkit.messageHandlers.showPhotoPicker.postMessage();</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">showPhotoPicker</span>(<span class="params">onSelected</span>: <span class="keyword">@escaping</span> <span class="type">PhotoSelectedCallback</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> imagePicker <span class="operator">=</span> <span class="type">UIImagePickerController</span>()</span><br><span class="line">        imagePicker.sourceType <span class="operator">=</span> .photoLibrary</span><br><span class="line">        imagePicker.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">        onPhotoSelected <span class="operator">=</span> onSelected</span><br><span class="line">        present(imagePicker, animated: <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">ViewController</span>: <span class="title class_">UIImagePickerControllerDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">imagePickerController</span>(<span class="keyword">_</span> <span class="params">picker</span>: <span class="type">UIImagePickerController</span>, <span class="params">didFinishPickingMediaWithInfo</span> <span class="params">info</span>: [<span class="type">UIImagePickerController</span>.<span class="params">InfoKey</span> : <span class="keyword">Any</span>]) &#123;</span><br><span class="line">        <span class="keyword">let</span> fileUrl <span class="operator">=</span> info[.imageURL]</span><br><span class="line">        picker.dismiss(animated: <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.onPhotoSelected<span class="operator">?</span>(fileUrl <span class="keyword">as!</span> <span class="type">NSURL</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">ViewController</span>: <span class="title class_">WKScriptMessageHandler</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userContentController</span>(<span class="keyword">_</span> <span class="params">userContentController</span>: <span class="type">WKUserContentController</span>, <span class="params">didReceive</span> <span class="params">message</span>: <span class="type">WKScriptMessage</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> message.name &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;showPhotoPicker&quot;</span>:</span><br><span class="line">            showPhotoPicker &#123; url <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> method <span class="operator">=</span> message.body <span class="keyword">as?</span> <span class="type">String</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> callStr <span class="operator">=</span> method <span class="operator">+</span> <span class="string">&quot;(<span class="subst">\&quot;</span>&quot;</span> <span class="operator">+</span> url.absoluteString<span class="operator">!</span> <span class="operator">+</span> <span class="string">&quot;<span class="subst">\&quot;</span>)&quot;</span></span><br><span class="line">                    <span class="keyword">self</span>.webview.evaluateJavaScript(callStr)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// do nothing or throw an error.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>打开相册<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            webkit.<span class="property">messageHandlers</span>.<span class="property">showPhotoPicker</span>.<span class="title function_">postMessage</span>(<span class="string">&quot;onGetPhoto&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">onGetPhoto</span>(<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;img&#x27;</span>).<span class="property">src</span> = data;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，一个 swift 调用 webview，webview 调用 swift 的简单功能就实现了。</p>
<p>不同语言之间的交互，由于数据类型不同，有种现实中语言不通的现象，我们只能够简单传递字符串的形式来实现通信。</p>
<p>因此，如果为了易用性，我们需要设计 SDK，才能在企业中使用，但是通过这个示例，简单了解了原生与 webview 是如何通信的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shenxiang11.github.io/blog/2023/04/20/Swift-%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%B8%8E-WebView-%E4%BA%92%E7%9B%B8%E9%80%9A%E4%BF%A1/" data-id="clh8m1lni000cbxq933w08vz3" data-title="Swift 原生应用与 WebView 互相通信" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Swift/" rel="tag">Swift</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/iOS/" rel="tag">iOS</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="extend next" rel="next" href="/blog/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Flutter/" rel="tag">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Javascript/" rel="tag">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Node-js/" rel="tag">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React-Native/" rel="tag">React Native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React-js/" rel="tag">React.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Swift/" rel="tag">Swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Typescript/" rel="tag">Typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue-router/" rel="tag">Vue-router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue-js/" rel="tag">Vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/gin/" rel="tag">gin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/swagger/" rel="tag">swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" rel="tag">位运算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">微信小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" rel="tag">计算机</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/blog/tags/Flutter/" style="font-size: 13.33px;">Flutter</a> <a href="/blog/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/blog/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/blog/tags/React-Native/" style="font-size: 13.33px;">React Native</a> <a href="/blog/tags/React-js/" style="font-size: 10px;">React.js</a> <a href="/blog/tags/Swift/" style="font-size: 16.67px;">Swift</a> <a href="/blog/tags/Typescript/" style="font-size: 10px;">Typescript</a> <a href="/blog/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/blog/tags/Vue-router/" style="font-size: 10px;">Vue-router</a> <a href="/blog/tags/Vue-js/" style="font-size: 10px;">Vue.js</a> <a href="/blog/tags/gin/" style="font-size: 10px;">gin</a> <a href="/blog/tags/go/" style="font-size: 10px;">go</a> <a href="/blog/tags/iOS/" style="font-size: 16.67px;">iOS</a> <a href="/blog/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/blog/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 10px;">位运算</a> <a href="/blog/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 10px;">微信小程序</a> <a href="/blog/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">排序</a> <a href="/blog/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.33px;">算法</a> <a href="/blog/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size: 10px;">计算机</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/04/">四月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2023/05/04/%E4%BB%BF%E4%B8%80%E4%B8%AA-AppStore-%E6%95%88%E6%9E%9C/">仿一个 AppStore 效果</a>
          </li>
        
          <li>
            <a href="/blog/2023/05/03/React-Strict-Mode-%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-Render-%E4%B8%A4%E6%AC%A1/">React Strict Mode 的作用：为什么我的 `useEffect` 执行了两次</a>
          </li>
        
          <li>
            <a href="/blog/2023/05/02/null-%E5%92%8C-undefined-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%E7%9C%8B%E7%9C%8B%E7%A5%96%E5%B8%88%E7%88%B7%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%B4%E7%9A%84/">null 和 undefined 的区别：看看祖师爷是怎么说的</a>
          </li>
        
          <li>
            <a href="/blog/2023/04/25/%E5%9C%A8-gin-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-swagger/">在 gin 项目中使用 swagger</a>
          </li>
        
          <li>
            <a href="/blog/2023/04/23/Node-js-%E6%89%93%E9%80%9A%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98/">Node.js 打通微信小程序支付</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 芯芯爸爸<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.4.1.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>